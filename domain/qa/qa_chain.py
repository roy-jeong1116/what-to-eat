from langchain_openai import ChatOpenAI
from langchain.prompts import PromptTemplate
from langchain_core.runnables import Runnable
from config import OPENAI_API_KEY


llm = ChatOpenAI(
    temperature=0.2,
    openai_api_key=OPENAI_API_KEY,
    model_name="gpt-4.1" 
)

# 1. ì…ë ¥ ë¶„ë¥˜ ì—ì´ì „íŠ¸
def classify_input(user_request: str) -> str:
    prompt = PromptTemplate.from_template("""
        ë„ˆëŠ” ì‚¬ìš©ìì˜ ìš”ì²­ì„ ì•„ë˜ ë‹¤ì„¯ ê°€ì§€ ìœ í˜• ì¤‘ í•˜ë‚˜ë¡œ ë¶„ë¥˜í•˜ëŠ” ë¶„ë¥˜ê¸° ì—­í• ì„ í•´.

        ì‚¬ìš©ìì˜ ì…ë ¥ì€ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ì— í•´ë‹¹í•  ìˆ˜ ìˆì–´:
        
        1. ì¼ë°˜ë ˆì‹œí”¼  
        - ì •ì˜: íŠ¹ì • ìš”ë¦¬ë¥¼ ì§€ì •í•˜ì§€ ì•Šê³ , ë¬´ì—‡ì„ ë¨¹ì„ì§€ ì¶”ì²œí•´ë‹¬ë¼ëŠ” ì¼ë°˜ì ì¸ ìš”ì²­  
        - ì˜ˆì‹œ:  
        - ì˜¤ëŠ˜ ë­ ë¨¹ì§€?  
        - ì €ë… ë©”ë‰´ ì¶”ì²œí•´ì¤˜  
        - ì•„ë¬´ê±°ë‚˜ ì¶”ì²œí•´ì¤˜  
        - ë ˆì‹œí”¼ ì¶”ì²œí•´ì¤˜  
        - ì˜¤ë­ë¨¹  

        2. ìš”ë¦¬í‚¤ì›Œë“œ  
        - ì •ì˜: ì‚¬ìš©ìê°€ 'íŒŒìŠ¤íƒ€', 'ê¹€ì¹˜ì°Œê°œ', 'ë³¶ìŒë°¥' ë“± íŠ¹ì • ìš”ë¦¬ ì´ë¦„ì„ í¬í•¨í•˜ì—¬ ê·¸ ìš”ë¦¬ì˜ ë ˆì‹œí”¼ë‚˜ ì¶”ì²œì„ ìš”ì²­í•˜ëŠ” ê²½ìš°  
        - ì˜ˆì‹œ:  
        - íŒŒìŠ¤íƒ€ ìš”ë¦¬ ì•Œë ¤ì¤˜  
        - ê¹€ì¹˜ì°Œê°œ ë ˆì‹œí”¼ ì•Œë ¤ì¤˜  
        - ë³¶ìŒë°¥ ì–´ë–»ê²Œ ë§Œë“¤ì–´?  
        - ë–¡ë³¶ì´ ë§Œë“¤ê³  ì‹¶ì–´  

        3. ì¬ë£Œí‚¤ì›Œë“œ  
        - ì •ì˜: íŠ¹ì • ì¬ë£Œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ í•œ ìš”ë¦¬ë¥¼ ìš”ì²­í•˜ëŠ” ê²½ìš°. 'ê°ì', 'ë©´', 'ê¹€ì¹˜', 'ì‹œê¸ˆì¹˜' ë“±  
        - ì˜ˆì‹œ:  
        - ê°ììš”ë¦¬ ë­ ìˆì„ê¹Œ?  
        - ë©´ ìš”ë¦¬ ì¶”ì²œí•´ì¤˜  
        - ê¹€ì¹˜ë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ìš”ë¦¬ ì•Œë ¤ì¤˜  
        - ì‹œê¸ˆì¹˜ ìš”ë¦¬ ë­ ìˆì–´?  

        4. ì¹´í…Œê³ ë¦¬  
        - ì •ì˜: ìš”ë¦¬ì˜ í° ë¶„ë¥˜ë‚˜ êµ­ê°€/ì§€ì—­ë³„ ë¶„ë¥˜ë¥¼ ìš”ì²­í•˜ëŠ” ê²½ìš°. 'í•œì‹', 'ì¤‘ì‹', 'ì¼ì‹', 'ì–‘ì‹' ë“±  
        - ì˜ˆì‹œ:  
        - í•œì‹ ì¶”ì²œí•´ì¤˜  
        - ì˜¤ëŠ˜ì€ ì¤‘ì‹ ë¨¹ê³  ì‹¶ì–´  
        - ì–‘ì‹ ìš”ë¦¬ ì•Œë ¤ì¤˜  
        - ì¼ì‹ìœ¼ë¡œ ë­ ë¨¹ì§€?  

        5. ì±—ë´‡ì •ë³´
        - ì •ì˜: ì‚¬ìš©ìê°€ ì±—ë´‡ì˜ ì •ì²´, ì—­í• , ì‚¬ìš©ë²• ë“±ì„ ë¬»ëŠ” ê²½ìš°. ì±—ë´‡ê³¼ ëŒ€í™”í•˜ëŠ” ë°©ë²•ì´ë‚˜ ê°€ëŠ¥í•œ ê¸°ëŠ¥ì„ ì•Œê³  ì‹¶ì–´í•˜ëŠ” ì§ˆë¬¸.
        - ì˜ˆì‹œ:
        - ?
        - ë„ˆ ë­ì•¼?
        - ë¬´ìŠ¨ ê¸°ëŠ¥ì´ ìˆì–´?
        - ì–´ë–»ê²Œ ì‚¬ìš©í•´?
        - í•  ìˆ˜ ìˆëŠ” ê²Œ ë­ì•¼?
        - ë­ í•´ì¤„ ìˆ˜ ìˆì–´?
        - ì–´ë–¤ ìš”ë¦¬ë¥¼ ì¶”ì²œí•´ì¤˜?
        - ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ëª…ë ¹ì–´ ì•Œë ¤ì¤˜
        - ì´ ì±—ë´‡ì€ ë­”ê°€ìš”?
                                          
        6. ì˜ˆì™¸
        - ì •ì˜: ìœ„ì˜ ì–´ë–¤ ë¶„ë¥˜ì—ë„ ì†í•˜ì§€ ì•Šê±°ë‚˜, ì˜ë¯¸ ì—†ëŠ” ë§, ì§ˆë¬¸ê³¼ ê´€ë ¨ ì—†ëŠ” ì…ë ¥
        - ì˜ˆì‹œ:
        - ì˜¤ëŠ˜ ë‚ ì”¨ ë­ì•¼
        - ì–´ìŠ·ì°ê¸°ëŠ” ì–´ë–»ê²Œ í•˜ëŠ”ê±°ì•¼?
        - ì¡¸ë ¤
        - ìŒí•˜í•˜
        - ë¼ë©´ì˜ ìœ ë˜ê°€ ë­˜ê¹Œ

        ------------------------------------------------------------
        ì‚¬ìš©ìì˜ ìš”ì²­ì„ ì½ê³ , ê°€ì¥ ì ì ˆí•œ ìœ í˜• í•˜ë‚˜ë¥¼ ì •í™•íˆ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¡œë§Œ ì¶œë ¥í•˜ì„¸ìš”:  
        ì¼ë°˜ë ˆì‹œí”¼, ìš”ë¦¬í‚¤ì›Œë“œ, ì¬ë£Œí‚¤ì›Œë“œ, ì¹´í…Œê³ ë¦¬, ì±—ë´‡ì •ë³´, ì˜ˆì™¸ì™¸
        ------------------------------------------------------------

        ì‚¬ìš©ì ìš”ì²­: "{user_request}"

        ë¶„ë¥˜:
    """)
    chain = prompt | llm
    return chain.invoke({"user_request": user_request}).content.strip()


# 2. ì¼ë°˜ ë ˆì‹œí”¼ ì¶”ì²œ (ì¬ê³ ë§Œ ì‚¬ìš©)
def recipe_by_inventory(ingredients: str, user_request: str) -> str:
    prompt = PromptTemplate.from_template("""

        ë‹¹ì‹ ì€ ì‚¬ìš©ìì˜ ëƒ‰ì¥ê³  ì† ì¬ë£Œë§Œì„ ì‚¬ìš©í•˜ì—¬, 1ì¸ë¶„ ìš”ë¦¬ë¥¼ ì¶”ì²œí•˜ëŠ” ìš”ë¦¬ ì¶”ì²œ ë„ìš°ë¯¸ì…ë‹ˆë‹¤.

        [ìš”ì²­ ì¡°ê±´]
        - ì‚¬ìš©ìì˜ ì¬ë£ŒëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:  
        {ingredients}
        

        - ë°˜ë“œì‹œ ìœ„ ì¬ë£Œì— ìˆëŠ” ì¬ë£Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ í™œìš©í•˜ë˜, ì¶”ê°€ë¡œ í•„ìš”í•œ ì¬ë£Œê°€ ìˆì–´ë„ ë¨.
        
        - ë³´í¸ì ì¸ ë ˆì‹œí”¼ë¥¼ ì¶”ì²œí•´ì£¼ì„¸ìš”
        - íŠ¹ì´í•˜ê±°ë‚˜ ë³µì¡í•œ ë ˆì‹œí”¼ëŠ” í”¼í•´ì£¼ì„¸ìš”

        [ì¶œë ¥ ê·œì¹™]
        - ì‚¬ìš©ìì˜ ì¬ë£Œê°€ **10ê°œ ì´í•˜**ì¸ ê²½ìš°:  
        â†’ "ì¬ë£Œê°€ ì ì–´ì„œ ê°„ë‹¨í•œ ìš”ë¦¬ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."ë¼ëŠ” ì•ˆë‚´ ë¬¸êµ¬ì™€ í•¨ê»˜  
        â†’ ë§Œë“¤ ìˆ˜ ìˆëŠ” ìš”ë¦¬ë¥¼ **1~3ê°œ** ì‚¬ì´ë¡œ ì¶”ì²œí•˜ì„¸ìš”.

        - ì‚¬ìš©ìì˜ ì¬ë£Œê°€ **10ê°œ ì´ìƒ**ì¸ ê²½ìš°:  
        â†’ ìš”ë¦¬ë¥¼ **ë°˜ë“œì‹œ 3ê°œ** ì¶”ì²œí•˜ì„¸ìš”.

        [ì¶œë ¥ í˜•ì‹]  
        ê° ìš”ë¦¬ëŠ” ì•„ë˜ í˜•ì‹ì„ ì •í™•íˆ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤:

        ğŸ² ìš”ë¦¬ ì´ë¦„  
        ğŸ“‹ í•„ìš”í•œ ì¬ë£Œ: (ê° ì¬ë£ŒëŠ” êµ¬ì²´ì ì¸ ì–‘ê¹Œì§€ ëª…ì‹œí•˜ì„¸ìš”)  
        ğŸ‘¨â€ğŸ³ ìš”ë¦¬ ë°©ë²•: (1ë²ˆë¶€í„° ë²ˆí˜¸ ìˆœì„œë¡œ ë‹¨ê³„ë³„ë¡œ ì‘ì„±í•˜ì„¸ìš”)

        ì˜ˆì‹œ í˜•ì‹:
        ğŸ² ë‹¬ê±€ í”„ë¼ì´  
        ğŸ“‹ í•„ìš”í•œ ì¬ë£Œ: ë‹¬ê±€ 1ê°œ, ì‹ìš©ìœ  1í°ìˆ   
        ğŸ‘¨â€ğŸ³ ìš”ë¦¬ ë°©ë²•:  
        1. í”„ë¼ì´íŒ¬ì— ì‹ìš©ìœ ë¥¼ ë‘ë¥´ê³  ì¤‘ë¶ˆë¡œ ì˜ˆì—´í•©ë‹ˆë‹¤.  
        2. ë‹¬ê±€ì„ ê¹¨ëœ¨ë ¤ ë„£ê³  ì›í•˜ëŠ” ë§Œí¼ ìµí™ë‹ˆë‹¤.

        [ë§ˆì§€ë§‰ ì£¼ì˜ì‚¬í•­]
        - ì¶œë ¥ í˜•ì‹ê³¼ ì¡°ê±´ì„ ë°˜ë“œì‹œ ì§€ì¼œì£¼ì„¸ìš”.
        - ì‚¬ìš©ìì˜ ì¬ë£Œê°€ 10ê°œ ì´í•˜ë¼ë©´ ë°˜ë“œì‹œ "ì¬ë£Œê°€ ì ì–´ì„œ ê°„ë‹¨í•œ ìš”ë¦¬ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."ë¼ëŠ” ì•ˆë‚´ ë¬¸êµ¬ë¥¼ ë ˆì‹œí”¼ ì•ì— ì¶œë ¥í•´ì¤˜
    """)
    chain = prompt | llm
    return chain.invoke({"ingredients": ingredients, "user_request": user_request}).content.strip()


# 3. ìš”ë¦¬ í‚¤ì›Œë“œ ì¶”ì²œ (ì¶”ê°€ ì¬ë£Œ í¬í•¨)
def recipe_with_extra(ingredients: str, user_request: str) -> str:
    prompt = PromptTemplate.from_template("""
        ë‹¹ì‹ ì€ ì‚¬ìš©ìì˜ ìš”ë¦¬ ìš”ì²­ í‚¤ì›Œë“œë¥¼ ë°”íƒ•ìœ¼ë¡œ ìš”ë¦¬ë¥¼ ì¶”ì²œí•˜ëŠ” ë ˆì‹œí”¼ ë„ìš°ë¯¸ì…ë‹ˆë‹¤.

        [ì‚¬ìš©ì ìš”ì²­]
        - ì‚¬ìš©ì ìš”ì²­: {user_request}
        - ì‚¬ìš©ì ë³´ìœ  ì¬ë£Œ: {ingredients}

        [ìš”ë¦¬ ì¶”ì²œ ê·œì¹™]
        1. ì‚¬ìš©ìê°€ ìš”ë¦¬ í‚¤ì›Œë“œë¥¼ ì¼ë°˜ì ìœ¼ë¡œ ì…ë ¥í•œ ê²½ìš°. í•´ë‹¹ ìš”ë¦¬ í‚¤ì›Œë“œì— ìƒì„¸í•œ ìš”ë¦¬ ë²„ì „ì— ì—¬ëŸ¬ê°œ ìˆì„ ê²½ìš°.
        (ì˜ˆ: "íŒŒìŠ¤íƒ€", "ê¹€ì¹˜ì°Œê°œ", "ëœì¥ì°Œê°œ" ë“±):  
        â†’ í•´ë‹¹ í‚¤ì›Œë“œì™€ ê´€ë ¨ëœ ë‹¤ì–‘í•œ ì¼ë°˜ ë ˆì‹œí”¼ë¥¼ 1~3ê°€ì§€ ì¶”ì²œí•˜ì„¸ìš”.  
        ì˜ˆ: "íŒŒìŠ¤íƒ€" ìš”ì²­ â†’ ì•Œë¦¬ì˜¤ì˜¬ë¦¬ì˜¤, í¬ë¦¼íŒŒìŠ¤íƒ€, ë°”ì§ˆíŒŒìŠ¤íƒ€ ë“±  

        2. ì‚¬ìš©ìê°€ êµ¬ì²´ì ì¸ ìš”ë¦¬ëª…ì„ ì…ë ¥í•œ ê²½ìš°  
        (ì˜ˆ: "ì°¸ì¹˜ê¹€ì¹˜ì°Œê°œ", "í† ë§ˆí† íŒŒìŠ¤íƒ€" ë“±):  
        â†’ í•´ë‹¹ ìš”ë¦¬ 1ê°€ì§€ë§Œ ìƒì„¸íˆ ì¶”ì²œí•˜ì„¸ìš”.

        3. ì¶”ì²œëœ ìš”ë¦¬ëŠ” ì¼ë°˜ì ì¸ ê°€ì •ì‹ ê¸°ì¤€ì´ì–´ì•¼ í•˜ë©°, ë„ˆë¬´ ìƒì†Œí•˜ê±°ë‚˜ íŠ¹ìˆ˜í•œ ìš”ë¦¬ëŠ” í”¼í•´ì£¼ì„¸ìš”.

        [ì¬ë£Œ ì²˜ë¦¬ ê·œì¹™]
        - ê° ìš”ë¦¬ë§ˆë‹¤ í•„ìš”í•œ ì „ì²´ ì¬ë£Œ ëª©ë¡ì„ ì‘ì„±í•˜ì„¸ìš”.
        - ì‚¬ìš©ì ë³´ìœ  ì¬ë£Œ({ingredients})ì™€ ë¹„êµí•˜ì—¬ ë¶€ì¡±í•œ ì¬ë£ŒëŠ”  
        â†’ 'ğŸ›’ ì¶”ê°€ë¡œ í•„ìš”í•œ ì¬ë£Œ' í•­ëª©ì— **ëˆ„ë½ ì—†ì´ ëª¨ë‘ ëª…ì‹œ**í•´ì•¼ í•©ë‹ˆë‹¤.
        - ë°˜ëŒ€ë¡œ ë³´ìœ í•˜ê³  ìˆëŠ” ì¬ë£ŒëŠ” ë”°ë¡œ í‘œì‹œí•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.

        [ì¶œë ¥ í˜•ì‹]
        ê° ìš”ë¦¬ëŠ” ì•„ë˜ í˜•ì‹ì„ ë°˜ë“œì‹œ ë”°ë¥´ì„¸ìš”:

        ğŸ² ìš”ë¦¬ ì´ë¦„  
        ğŸ“‹ í•„ìš”í•œ ì¬ë£Œ: (ê° ì¬ë£ŒëŠ” êµ¬ì²´ì ì¸ ì–‘ê¹Œì§€ ëª…ì‹œ)  
        ğŸ‘¨â€ğŸ³ ìš”ë¦¬ ë°©ë²•: (ë²ˆí˜¸ ìˆœì„œë¡œ ë‹¨ê³„ë³„ ì‘ì„±)  
        ğŸ›’ ì¶”ê°€ë¡œ í•„ìš”í•œ ì¬ë£Œ: í•„ìš”í•œ ì¬ë£Œì™€ {ingredients}ë¥¼ ë¹„êµí•´ì„œ {ingredients}ì— ì—†ëŠ” ì¬ë£Œë¥¼ ë°˜ë“œì‹œ ì¶œë ¥.

        [ì˜ˆì‹œ í˜•ì‹]
        ğŸ² ì•Œë¦¬ì˜¤ì˜¬ë¦¬ì˜¤  
        ğŸ“‹ í•„ìš”í•œ ì¬ë£Œ: ìŠ¤íŒŒê²Œí‹° ë©´ 100g, ë§ˆëŠ˜ 3ìª½, ì˜¬ë¦¬ë¸Œìœ  2í°ìˆ , ì†Œê¸ˆ ì•½ê°„  
        ğŸ‘¨â€ğŸ³ ìš”ë¦¬ ë°©ë²•:  
        1. ìŠ¤íŒŒê²Œí‹° ë©´ì„ ì†Œê¸ˆë¬¼ì— ì‚¶ìŠµë‹ˆë‹¤.  
        2. íŒ¬ì— ì˜¬ë¦¬ë¸Œìœ ì™€ ë§ˆëŠ˜ì„ ë³¶ì•„ í–¥ì„ ëƒ…ë‹ˆë‹¤.  
        3. ë©´ì„ ë„£ê³  ì˜ ì„ì–´ ë³¶ì•„ì¤ë‹ˆë‹¤.  
        ğŸ›’ ì¶”ê°€ë¡œ í•„ìš”í•œ ì¬ë£Œ: ìŠ¤íŒŒê²Œí‹° ë©´, ì˜¬ë¦¬ë¸Œìœ 

        [ì£¼ì˜ì‚¬í•­]
        - ë°˜ë“œì‹œ ì¶œë ¥ í˜•ì‹ì„ ì§€í‚¤ì„¸ìš”. í˜•ì‹ ì™¸ ë¬¸ì¥ ì¶œë ¥ ê¸ˆì§€.
        - â€˜ì¶”ê°€ë¡œ í•„ìš”í•œ ì¬ë£Œâ€™ëŠ” ì ˆëŒ€ ëˆ„ë½í•˜ì§€ ë§ˆì„¸ìš”.
        - ì‚¬ìš©ìì˜ ìš”ì²­ í‚¤ì›Œë“œê°€ êµ¬ì²´ì ì¸ ìš”ë¦¬ ì´ë¦„ì¸ì§€ ì¼ë°˜ í‚¤ì›Œë“œì¸ì§€ ì˜ íŒŒì•…í•˜ì„¸ìš”.
        
    """)

    chain = prompt | llm
    return chain.invoke({"ingredients": ingredients, "user_request": user_request}).content.strip()

# ì¬ë£Œí‚¤ì›Œë“œ
def keword_recipe(ingredients: str, user_request: str) -> str:
    prompt = PromptTemplate.from_template("""
        ë‹¹ì‹ ì€ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì¬ë£Œ í‚¤ì›Œë“œë¥¼ ë°”íƒ•ìœ¼ë¡œ, í•´ë‹¹ ì¬ë£Œë¥¼ í™œìš©í•œ ìš”ë¦¬ ë ˆì‹œí”¼ë¥¼ ì¶”ì²œí•˜ëŠ” ì¹œì ˆí•œ ë ˆì‹œí”¼ ë„ìš°ë¯¸ì…ë‹ˆë‹¤.

        [ì‚¬ìš©ì ìš”ì²­]  
        - ì‚¬ìš©ì ìš”ì²­ í‚¤ì›Œë“œ: {user_request}  
        - ì‚¬ìš©ì ë³´ìœ  ì¬ë£Œ: {ingredients}

        [ìš”ë¦¬ ì¶”ì²œ ê·œì¹™]  
        1. ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì¬ë£Œ í‚¤ì›Œë“œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ, ê·¸ ì¬ë£Œë¥¼ ì£¼ë¡œ ì‚¬ìš©í•˜ëŠ” ì¼ë°˜ì ì¸ ê°€ì •ì‹ ë ˆì‹œí”¼ë¥¼ 1~3ê°€ì§€ ì¶”ì²œí•˜ì„¸ìš”. ë°˜ë“œì‹œ ì‚¬ìš©ìê°€ ìš”ì²­í•œ ì¬ë£Œë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
        2. ê° ë ˆì‹œí”¼ëŠ” ëª¨ë‘ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” í”í•œ ìš”ë¦¬ì—¬ì•¼ í•˜ë©°, ë„ˆë¬´ ìƒì†Œí•˜ê±°ë‚˜ íŠ¹ìˆ˜í•œ ìš”ë¦¬ëŠ” ì œì™¸í•˜ì„¸ìš”.  
        3. ì¶”ì²œí•˜ëŠ” ë ˆì‹œí”¼ëŠ” ëª¨ë‘ ì¼ë°˜ì ì¸ ì¡°ë¦¬ë²•ì„ ê¸°ì¤€ìœ¼ë¡œ í•©ë‹ˆë‹¤.

        [ì¬ë£Œ ì²˜ë¦¬ ê·œì¹™]  
        - ê° ë ˆì‹œí”¼ë§ˆë‹¤ í•„ìš”í•œ ì „ì²´ ì¬ë£Œ ëª©ë¡ì„ êµ¬ì²´ì ì¸ ì–‘ê³¼ í•¨ê»˜ ì‘ì„±í•˜ì„¸ìš”.  
        - ì‚¬ìš©ì ë³´ìœ  ì¬ë£Œ({ingredients})ì™€ ë¹„êµí•´ ë¶€ì¡±í•œ ì¬ë£Œê°€ ìˆìœ¼ë©´, ë°˜ë“œì‹œ â€˜ğŸ›’ ì¶”ê°€ë¡œ í•„ìš”í•œ ì¬ë£Œâ€™ í•­ëª©ì— ëˆ„ë½ ì—†ì´ ëª¨ë‘ ëª…ì‹œí•˜ì„¸ìš”.  
        - ë³´ìœ í•œ ì¬ë£ŒëŠ” ë”°ë¡œ ì ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.

        [ì¶œë ¥ í˜•ì‹]  
        ì•„ë˜ í˜•ì‹ì„ ë°˜ë“œì‹œ ì§€ì¼œ ì¶œë ¥í•˜ì„¸ìš”.

        ğŸ² ìš”ë¦¬ ì´ë¦„  
        ğŸ“‹ í•„ìš”í•œ ì¬ë£Œ: (ì¬ë£Œëª…ê³¼ êµ¬ì²´ì ì¸ ì–‘ í¬í•¨)  
        ğŸ‘¨â€ğŸ³ ìš”ë¦¬ ë°©ë²•: (ë²ˆí˜¸ ìˆœì„œë¡œ ë‹¨ê³„ë³„ ì‘ì„±)  
        ğŸ›’ ì¶”ê°€ë¡œ í•„ìš”í•œ ì¬ë£Œ: (í•„ìš”í•œ ì¬ë£Œì™€ ì‚¬ìš©ìì˜ {ingredients}ë¥¼ ë¹„êµí•˜ì—¬ {ingredients}ì— ì—†ëŠ” ì¬ë£Œë§Œ ëª…í™•íˆ ê¸°ì¬)

        [ì£¼ì˜ì‚¬í•­]  
        - ì¶œë ¥ í˜•ì‹ì„ ë²—ì–´ë‚˜ì§€ ë§ˆì„¸ìš”.  
        - â€˜ì¶”ê°€ë¡œ í•„ìš”í•œ ì¬ë£Œâ€™ëŠ” ë°˜ë“œì‹œ ëˆ„ë½ ì—†ì´ ì‘ì„±í•˜ì„¸ìš”.  
        - ì‚¬ìš©ìì˜ ìš”ì²­ì´ ì¬ë£Œ í‚¤ì›Œë“œì„ì„ ì¸ì§€í•˜ê³  ê·¸ì— ë§ê²Œ ë ˆì‹œí”¼ë¥¼ ì¶”ì²œí•˜ì„¸ìš”.

    
    """)
    chain = prompt | llm
    return chain.invoke({"ingredients": ingredients,"user_request": user_request}).content.strip()

# 4. ì¹´í…Œê³ ë¦¬ ê¸°ë°˜ ìš”ë¦¬ ì¶”ì²œ
def category_recipe(ingredients : str, user_request: str) -> str:
    prompt = PromptTemplate.from_template("""
        ë‹¹ì‹ ì€ ìš”ë¦¬ ì „ë¬¸ê°€ì´ì ë ˆì‹œí”¼ ë„ìš°ë¯¸ì…ë‹ˆë‹¤.
                                          
         [ì‚¬ìš©ì ìš”ì²­]  
        - ì‚¬ìš©ì ìš”ì²­ í‚¤ì›Œë“œ: {user_request}  
        - ì‚¬ìš©ì ë³´ìœ  ì¬ë£Œ: {ingredients}

        ì‚¬ìš©ìê°€ ìš”ì²­í•œ ìŒì‹ ì¹´í…Œê³ ë¦¬(ì˜ˆ: ì¤‘ì‹, ì¼ì‹, ì–‘ì‹, íƒœêµ­ìŒì‹ ë“±)ë¥¼ ë°”íƒ•ìœ¼ë¡œ  
        í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ì†í•˜ëŠ” ëŒ€í‘œì ì´ê³  ì¼ë°˜ì ì¸ ìš”ë¦¬ 3ê°€ì§€ë¥¼ ì¶”ì²œí•´ì£¼ì„¸ìš”.  

        ì¶”ì²œí•˜ëŠ” ê° ìš”ë¦¬ëŠ” ì‹¤ì œë¡œ í”íˆ ì•Œë ¤ì§„ ë ˆì‹œí”¼ì—¬ì•¼ í•˜ë©°, ë„ˆë¬´ ìƒì†Œí•˜ê±°ë‚˜ íŠ¹ìˆ˜í•œ ìš”ë¦¬ëŠ” ì œì™¸í•©ë‹ˆë‹¤.  


        [ìš”ë¦¬ ì¶”ì²œ ê·œì¹™]  
        ê° ìš”ë¦¬ë³„ë¡œ ì•„ë˜ ì‚¬í•­ì„ ë°˜ë“œì‹œ ì§€ì¼œ ì‘ì„±í•´ì£¼ì„¸ìš”:  

        ğŸ² ìš”ë¦¬ ì´ë¦„  
        ğŸ“‹ í•„ìš”í•œ ì¬ë£Œ: ì¬ë£Œëª…ê³¼ êµ¬ì²´ì ì¸ ì–‘ì„ ëª¨ë‘ í¬í•¨
        ğŸ‘¨â€ğŸ³ ìš”ë¦¬ ë°©ë²•: ë²ˆí˜¸ ìˆœì„œì— ë”°ë¼ ë‹¨ê³„ë³„ë¡œ ì‰½ê²Œ ë”°ë¼í•  ìˆ˜ ìˆê²Œ ì‘ì„±  
        ğŸ›’ ì¶”ê°€ë¡œ í•„ìš”í•œ ì¬ë£Œ: "í•„ìš”í•œ ì¬ë£Œ"ì™€ {ingredients}ë¥¼ ë¹„êµí•˜ì—¬ {ingredients}ì— ì—†ëŠ” ì¬ë£Œë§Œ ëˆ„ë½ ì—†ì´ ëª¨ë‘ ëª…í™•í•˜ê²Œ ê¸°ì¬  

        ì¶œë ¥ í˜•ì‹ ì™¸ ë‹¤ë¥¸ ë¬¸ì¥ì´ë‚˜ ì„¤ëª…ì€ ì‘ì„±í•˜ì§€ ë§ˆì„¸ìš”.  
        ë°˜ë“œì‹œ í˜•ì‹ì— ë§ê²Œ ì¶œë ¥í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
    """)
    chain = prompt | llm
    return chain.invoke({"ingredients": ingredients, "user_request": user_request}).content.strip()


# 5. ì•± ì„¤ëª… ì—ì´ì „íŠ¸
def explain_app() -> str:
    return """
        ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ã€ë­ë¨¹ì„ëƒ‰?ã€ì´ë¼ëŠ” ìš”ë¦¬ ì¶”ì²œ ì±—ë´‡ì´ì—ìš” ğŸ³  
        ë‹¹ì‹ ì˜ 'ëƒ‰ì¥ê³  ì† ì¬ë£Œ'ì™€ 'ìš”ë¦¬ ê´€ë ¨ ìš”ì²­'ì„ ë°”íƒ•ìœ¼ë¡œ,  
        ê°„ë‹¨í•œ ë ˆì‹œí”¼ 1~3ê°€ì§€**ë¥¼ ì¶”ì²œí•´ë“œë ¤ìš”!

        ğŸ‘€ ã€ë­ë¨¹ì„ëƒ‰?ã€ì€ ì´ëŸ° ìƒí™©ì—ì„œ ìœ ìš©í•´ìš”:  
        - "ì˜¤ëŠ˜ ë­ ë¨¹ì§€?" ê³ ë¯¼ë  ë•Œ  
        - "ê¹€ì¹˜ì°Œê°œ ë¨¹ê³  ì‹¶ì€ë° ì¬ë£Œ ë˜ë ¤ë‚˜?" ì‹¶ì„ ë•Œ  
        - "ê°ìë°–ì— ì—†ëŠ”ë° ë­ í•´ë¨¹ì§€?"ì²˜ëŸ¼ ì¬ë£Œë§Œ ìˆì„ ë•Œ  
        - ëƒ‰ì¥ê³ ì— ë­ê°€ ìˆê¸´ í•œë° ì–´ë–»ê²Œ ì¡°í•©í•´ì•¼ í• ì§€ ëª¨ë¥¼ ë•Œ

        ğŸ± ì–´ë–»ê²Œ ì‘ë™í•˜ë‚˜ìš”?
        1. "ì˜¤ëŠ˜ ë­ ë¨¹ì§€?"  â†’ ëƒ‰ì¥ê³  ì† ì¬ë£Œë¡œ ê°€ëŠ¥í•œ ê°„ë‹¨í•œ ìš”ë¦¬ ì¶”ì²œ!  
        2. ìš”ë¦¬ëª…ì„ ì…ë ¥í•˜ë©´ â†’ í•´ë‹¹ ìš”ë¦¬ ë˜ëŠ” ë¹„ìŠ·í•œ ìš”ë¦¬ ì¶”ì²œ!  
        3. íŠ¹ì • ì¬ë£Œ ì¤‘ì‹¬ìœ¼ë¡œ â†’ ê·¸ ì¬ë£Œë¥¼ í™œìš©í•œ ë ˆì‹œí”¼ ì¶”ì²œ!  
        4. í•œì‹/ì¤‘ì‹/ì–‘ì‹ì²˜ëŸ¼ â†’ ì¹´í…Œê³ ë¦¬ì— ë§ëŠ” ìš”ë¦¬ ì¶”ì²œ!  
        5. ì–´ë–¤ ê²½ìš°ë“  â†’ ë¶€ì¡±í•œ ì¬ë£Œë„ í•¨ê»˜ ì•Œë ¤ì¤˜ìš”!

        ğŸ“Œ TIP:  
        - **ì…ë ¥í•œ ì¬ë£Œê°€ ë§ì„ìˆ˜ë¡** ë” ë‹¤ì–‘í•˜ê³  ì œëŒ€ë¡œ ëœ ìš”ë¦¬ë¥¼ ì¶”ì²œë°›ì„ ìˆ˜ ìˆì–´ìš”.  
        - ê°„ë‹¨í•œ ìš”ë¦¬ë¶€í„° ì •í†µ ë ˆì‹œí”¼ê¹Œì§€! ë‹¹ì‹ ì˜ ì·¨í–¥ê³¼ ëƒ‰ì¥ê³  ìƒí™©ì— ë§ì¶° ì•Œë ¤ë“œë ¤ìš”.

        ë¬´ì—‡ì„ ë¨¹ì„ì§€ ê³ ë¯¼ë  ë•Œ, ã€ë­ë¨¹ì„ëƒ‰?ã€ì´ í•¨ê»˜í• ê²Œìš”!
"""

# ì˜ˆì™¸ ì—ì´ì „íŠ¸
def other(user_request: str) -> str:
    prompt = PromptTemplate.from_template("""
        ë„ˆëŠ” ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ë‹µí•˜ëŠ” ì¹œì ˆí•œ ì±—ë´‡ì´ì•¼. í•˜ì§€ë§Œ ë„ˆëŠ” ì˜¤ì§ ìš”ë¦¬ë‚˜ ì‹ì¬ë£Œì— ê´€í•œ ì§ˆë¬¸ì—ë§Œ ëŒ€ë‹µí•  ìˆ˜ ìˆì–´.

        ì•„ë˜ ì§€ì¹¨ì„ ë”°ë¥´ì„¸ìš”:

        1. ì‚¬ìš©ìì˜ ì§ˆë¬¸ì´ ìš”ë¦¬ë‚˜ ì‹ì¬ë£Œì— ê´€í•œ ì´ì•¼ê¸°ê¸°(ì˜ˆ: ìœ í†µê¸°í•œ, ì¡°ë¦¬ë²•, ì†ì§ˆë²•, ë³´ê´€ë²• ë“±)ì´ë©´ ê°„ë‹¨í•˜ê³  ì •í™•í•˜ê²Œ ë‹µë³€í•´ì¤˜.
        2. ì§ˆë¬¸ì´ ìš”ë¦¬ë‚˜ ì‹ì¬ë£Œì™€ ê´€ë ¨ ì—†ëŠ” ê²½ìš°(ì˜ˆ: ë‚ ì”¨, ê°ì • í‘œí˜„, ì¼ìƒ ëŒ€í™” ë“±)ì—ëŠ” ì•„ë˜ ë¬¸ì¥ì„ ê·¸ëŒ€ë¡œ ì¶œë ¥í•´:
        "ì €ëŠ” [ë­ë¨¹ì„ëƒ‰?] ì…ë‹ˆë‹¤. ìš”ë¦¬ë‚˜ ì‹ì¬ë£Œì™€ ê´€ë ¨ëœ ì´ì•¼ê¸°ë§Œ í•´ì£¼ì„¸ìš”."

        ì‚¬ìš©ì ì§ˆë¬¸: "{user_request}"

        ë‹µë³€:
    """)
    chain = prompt | llm
    return chain.invoke({"user_request": user_request}).content.strip()


#  ì „ì²´ ìš”ì²­ ë¼ìš°íŒ… í•¨ìˆ˜
def route_request(user_request: str, user_ingredients: str) -> str:
    category = classify_input(user_request)
    print(category)

    if category == "ì¼ë°˜ë ˆì‹œí”¼":
        return recipe_by_inventory(user_ingredients, user_request)
    elif category == "ìš”ë¦¬í‚¤ì›Œë“œ":
        return recipe_with_extra(user_ingredients, user_request)
    elif category == "ì¹´í…Œê³ ë¦¬":
        return category_recipe(user_ingredients,user_request)
    elif category == "ì¬ë£Œí‚¤ì›Œë“œ":
        return keword_recipe(user_ingredients, user_request)
    elif category == "ì±—ë´‡ì •ë³´":
        return explain_app()
    else: # ì˜ˆì™¸
        return other(user_request)